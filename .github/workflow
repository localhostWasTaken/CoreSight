name: CoreSight Webhook Integration

on:
  push:
    branches: ['*']
  pull_request:
    types: [opened, closed, synchronize, reopened]

jobs:
  notify-coresight:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to fetch diffs via API
    steps:
      - name: Send Push Event with Diffs to CoreSight
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WEBHOOK_URL: "https://truthful-indescribably-odette.ngrok-free.dev/api/webhook/github"
          # Pass the raw commits JSON safely as an environment variable
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
          REPO_FULL_NAME: ${{ github.repository }}
          REF: ${{ github.ref }}
          PUSHER_NAME: ${{ github.actor }}
          PUSHER_EMAIL: ${{ github.event.pusher.email }}
        run: |
          python3 -c '
          import os
          import json
          import urllib.request
          import urllib.error

          def get_commit_diff(repo, commit_id, token):
              """Fetches the commit details from GitHub API to get the patch/diff."""
              url = f"https://api.github.com/repos/{repo}/commits/{commit_id}"
              headers = {
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github.v3+json"
              }
              try:
                  req = urllib.request.Request(url, headers=headers)
                  with urllib.request.urlopen(req) as response:
                      data = json.loads(response.read().decode())
                      
                      # Reconstruct the full diff from file patches
                      full_diff = ""
                      for file in data.get("files", []):
                          filename = file.get("filename")
                          patch = file.get("patch", "")
                          full_diff += f"--- a/{filename}\n+++ b/{filename}\n{patch}\n"
                      return full_diff
              except Exception as e:
                  print(f"Failed to fetch diff for {commit_id}: {e}")
                  return "Error fetching diff"

          # 1. Setup Data
          commits = json.loads(os.environ["COMMITS_JSON"])
          repo = os.environ["REPO_FULL_NAME"]
          token = os.environ["GITHUB_TOKEN"]
          
          # 2. Iterate commits and enrich with diffs
          enriched_commits = []
          for commit in commits:
              print(f"Fetching diff for {commit["id"]}...")
              diff = get_commit_diff(repo, commit["id"], token)
              
              # Create a new commit object with the diff included
              commit_data = {
                  "id": commit["id"],
                  "message": commit["message"],
                  "timestamp": commit["timestamp"],
                  "url": commit["url"],
                  "author": commit["author"],
                  "diff": diff  # <--- THIS IS THE NEW FIELD
              }
              enriched_commits.append(commit_data)

          # 3. Construct Final Payload
          payload = {
              "ref": os.environ["REF"],
              "repository": {
                  "full_name": repo,
                  "name": repo.split("/")[-1]
              },
              "pusher": {
                  "name": os.environ["PUSHER_NAME"],
                  "email": os.environ["PUSHER_EMAIL"]
              },
              "commits": enriched_commits
          }

          # 4. Send to CoreSight
          req = urllib.request.Request(
              os.environ["WEBHOOK_URL"],
              data=json.dumps(payload).encode("utf-8"),
              headers={
                  "Content-Type": "application/json",
                  "X-GitHub-Event": "push"
              },
              method="POST"
          )
          
          try:
              with urllib.request.urlopen(req) as resp:
                  print(f"Webhook sent: {resp.status}")
          except urllib.error.HTTPError as e:
              print(f"Webhook failed: {e.code} {e.read().decode()}")
              exit(1)
          '

      # Keep the PR step as is (PRs usually don't need per-commit diffs in the webhook)
      - name: Send PR Event to CoreSight
        if: github.event_name == 'pull_request'
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: pull_request" \
            -d '{
              "action": "${{ github.event.action }}",
              "pull_request": {
                "number": ${{ github.event.pull_request.number }},
                "title": ${{ toJson(github.event.pull_request.title) }},
                "user": { "login": "${{ github.event.pull_request.user.login }}" },
                "head": { "ref": "${{ github.event.pull_request.head.ref }}" },
                "base": { "ref": "${{ github.event.pull_request.base.ref }}" }
              },
              "repository": {
                "name": "${{ github.event.repository.name }}",
                "full_name": "${{ github.repository }}"
              }
            }' \
            "https://truthful-indescribably-odette.ngrok-free.dev/api/webhook/github"a
